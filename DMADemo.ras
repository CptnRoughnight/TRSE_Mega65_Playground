/******************************************************************** 
	DMADemo
	demonstrates the use of Mega65's DMagick to fast copy and fill
	parts of memory
 ******************************************************************** 

 ********************************************************************/
program DMADemo;

@use "DMA"

// 1000 bytes of random values

var @donotremove values
	values : array[2000] of byte = (
	65,79,27,39,77,72,49,37,63,76,38,46,37,27,42,5,49,49,28,14,27,77,16,51,67,57,1,66,26,73,56,44,24,35,35,53,59,36,10,43,32,1,9,21,60,3,58,29,53,6,44,32,4,12,36,71,69,69,57,48,62,65,44,38,53,31,44,32,68,6,27,52,7,69,26,67,72,4,49,77,11,45,62,15,57,18,38,79,7,47,79,21,65,43,11,38,26,55,70,14,62,18,19,21,7,45,9,31,49,10,29,60,55,43,27,64,61,17,63,20,65,62,41,50,57,4,40,4,60,30,50,74,0,21,15,39,66,56,71,68,66,52,0,73,15,60,58,28,77,41,48,14,56,41,16,65,45,56,21,25,39,72,51,39,13,19,31,32,75,54,20,14,58,52,7,25,32,17,53,30,59,21,44,67,14,61,52,59,69,74,37,28,18,8,68,63,27,51,15,55,25,67,21,3,40,60,28,72,78,1,54,9,54,19,76,68,32,0,79,21,26,36,50,76,77,70,60,56,41,27,63,66,15,4,69,7,17,49,79,47,2,54,56,56,25,4,76,9,36,75,30,15,64,0,11,61,22,23,69,63,51,53,1,66,57,22,25,26,71,56,73,73,30,49,1,7,5,77,16,42,25,47,57,41,79,20,54,54,44,43,69,15,16,71,33,26,13,58,52,5,34,78,30,17,79,32,56,5,61,73,79,38,72,8,79,23,28,5,29,72,49,19,39,17,10,24,43,23,2,48,60,69,78,11,38,77,75,14,2,56,39,1,47,63,41,78,39,70,4,68,14,5,7,54,22,17,30,18,73,65,18,5,54,16,48,44,13,43,10,48,52,2,1,51,65,43,49,24,33,53,45,47,10,52,53,33,22,4,51,47,21,69,52,27,37,53,71,50,48,1,18,20,35,20,23,21,63,73,77,48,78,42,47,9,47,53,74,21,9,77,68,30,18,72,57,55,45,48,57,14,1,76,66,37,48,42,10,63,35,39,31,65,34,78,26,1,3,20,54,12,49,74,42,67,66,51,42,64,51,20,30,5,48,48,42,16,10,4,79,77,43,62,63,29,12,41,30,16,62,36,60,31,30,55,51,49,26,45,33,78,65,15,3,65,63,77,33,26,33,64,23,28,46,38,58,11,0,40,27,14,77,39,77,59,14,48,28,73,14,61,71,31,28,26,17,12,55,50,38,8,35,13,36,33,52,14,44,52,7,23,66,4,63,63,63,29,64,44,22,78,25,13,29,54,71,46,18,46,49,8,54,4,21,43,69,73,9,34,77,16,9,15,52,72,31,68,54,15,32,76,13,9,42,74,15,33,73,33,32,42,41,6,78,63,1,67,8,11,53,6,59,63,21,64,55,52,52,29,19,4,58,64,45,20,59,61,5,52,14,37,46,8,76,44,23,77,63,31,40,37,69,52,20,43,36,27,47,8,9,67,44,67,51,9,39,62,70,44,34,37,34,0,77,30,76,20,59,60,3,20,49,25,24,69,68,60,48,35,68,57,22,64,76,26,73,67,8,16,32,75,53,18,27,2,48,24,22,27,36,57,79,5,2,23,26,70,3,26,58,23,4,0,7,32,58,33,20,19,49,4,14,54,54,41,56,22,17,30,1,5,7,33,42,42,56,20,64,12,47,42,67,3,75,75,67,53,28,39,72,29,75,38,3,49,0,59,71,49,41,25,7,48,58,49,42,34,22,27,78,69,69,66,24,16,13,11,70,41,51,14,22,46,53,25,16,5,36,39,6,77,64,45,77,42,47,40,29,69,19,59,10,40,45,34,57,58,45,79,51,48,45,73,47,50,18,15,55,6,54,14,3,71,59,1,65,26,73,46,47,12,26,57,4,23,11,61,2,9,60,53,57,58,79,56,28,49,71,36,56,78,50,59,69,61,12,6,40,5,5,7,49,31,65,54,6,28,67,8,37,0,14,47,58,13,23,6,62,15,42,70,13,44,50,34,26,14,72,18,52,77,25,21,60,42,27,67,71,47,27,28,47,41,27,25,6,51,63,21,18,26,11,31,22,13,17,0,28,41,18,0,39,44,53,51,6,33,70,29,0,18,10,79,11,37,56,50,8,39,71,26,17,34,9,40,48,58,40,28,20,59,28,11,55,33,62,13,66,53,43,66,23,53,17,66,10,73,36,51,33,59,29,50,46,71,42,14,49,3,74,69,14,22,0,69,7,15,2,74,20,77,12,43,50,30,61,13,23,18,16,8,29,77,59,75,68,21,41,38,56,35,
	65,79,27,39,77,72,49,37,63,76,38,46,37,27,42,5,49,49,28,14,27,77,16,51,67,57,1,66,26,73,56,44,24,35,35,53,59,36,10,43,32,1,9,21,60,3,58,29,53,6,44,32,4,12,36,71,69,69,57,48,62,65,44,38,53,31,44,32,68,6,27,52,7,69,26,67,72,4,49,77,11,45,62,15,57,18,38,79,7,47,79,21,65,43,11,38,26,55,70,14,62,18,19,21,7,45,9,31,49,10,29,60,55,43,27,64,61,17,63,20,65,62,41,50,57,4,40,4,60,30,50,74,0,21,15,39,66,56,71,68,66,52,0,73,15,60,58,28,77,41,48,14,56,41,16,65,45,56,21,25,39,72,51,39,13,19,31,32,75,54,20,14,58,52,7,25,32,17,53,30,59,21,44,67,14,61,52,59,69,74,37,28,18,8,68,63,27,51,15,55,25,67,21,3,40,60,28,72,78,1,54,9,54,19,76,68,32,0,79,21,26,36,50,76,77,70,60,56,41,27,63,66,15,4,69,7,17,49,79,47,2,54,56,56,25,4,76,9,36,75,30,15,64,0,11,61,22,23,69,63,51,53,1,66,57,22,25,26,71,56,73,73,30,49,1,7,5,77,16,42,25,47,57,41,79,20,54,54,44,43,69,15,16,71,33,26,13,58,52,5,34,78,30,17,79,32,56,5,61,73,79,38,72,8,79,23,28,5,29,72,49,19,39,17,10,24,43,23,2,48,60,69,78,11,38,77,75,14,2,56,39,1,47,63,41,78,39,70,4,68,14,5,7,54,22,17,30,18,73,65,18,5,54,16,48,44,13,43,10,48,52,2,1,51,65,43,49,24,33,53,45,47,10,52,53,33,22,4,51,47,21,69,52,27,37,53,71,50,48,1,18,20,35,20,23,21,63,73,77,48,78,42,47,9,47,53,74,21,9,77,68,30,18,72,57,55,45,48,57,14,1,76,66,37,48,42,10,63,35,39,31,65,34,78,26,1,3,20,54,12,49,74,42,67,66,51,42,64,51,20,30,5,48,48,42,16,10,4,79,77,43,62,63,29,12,41,30,16,62,36,60,31,30,55,51,49,26,45,33,78,65,15,3,65,63,77,33,26,33,64,23,28,46,38,58,11,0,40,27,14,77,39,77,59,14,48,28,73,14,61,71,31,28,26,17,12,55,50,38,8,35,13,36,33,52,14,44,52,7,23,66,4,63,63,63,29,64,44,22,78,25,13,29,54,71,46,18,46,49,8,54,4,21,43,69,73,9,34,77,16,9,15,52,72,31,68,54,15,32,76,13,9,42,74,15,33,73,33,32,42,41,6,78,63,1,67,8,11,53,6,59,63,21,64,55,52,52,29,19,4,58,64,45,20,59,61,5,52,14,37,46,8,76,44,23,77,63,31,40,37,69,52,20,43,36,27,47,8,9,67,44,67,51,9,39,62,70,44,34,37,34,0,77,30,76,20,59,60,3,20,49,25,24,69,68,60,48,35,68,57,22,64,76,26,73,67,8,16,32,75,53,18,27,2,48,24,22,27,36,57,79,5,2,23,26,70,3,26,58,23,4,0,7,32,58,33,20,19,49,4,14,54,54,41,56,22,17,30,1,5,7,33,42,42,56,20,64,12,47,42,67,3,75,75,67,53,28,39,72,29,75,38,3,49,0,59,71,49,41,25,7,48,58,49,42,34,22,27,78,69,69,66,24,16,13,11,70,41,51,14,22,46,53,25,16,5,36,39,6,77,64,45,77,42,47,40,29,69,19,59,10,40,45,34,57,58,45,79,51,48,45,73,47,50,18,15,55,6,54,14,3,71,59,1,65,26,73,46,47,12,26,57,4,23,11,61,2,9,60,53,57,58,79,56,28,49,71,36,56,78,50,59,69,61,12,6,40,5,5,7,49,31,65,54,6,28,67,8,37,0,14,47,58,13,23,6,62,15,42,70,13,44,50,34,26,14,72,18,52,77,25,21,60,42,27,67,71,47,27,28,47,41,27,25,6,51,63,21,18,26,11,31,22,13,17,0,28,41,18,0,39,44,53,51,6,33,70,29,0,18,10,79,11,37,56,50,8,39,71,26,17,34,9,40,48,58,40,28,20,59,28,11,55,33,62,13,66,53,43,66,23,53,17,66,10,73,36,51,33,59,29,50,46,71,42,14,49,3,74,69,14,22,0,69,7,15,2,74,20,77,12,43,50,30,61,13,23,18,16,8,29,77,59,75,68,21,41,38,56,35);

	i : integer;
	p : pointer;
begin
		// poke 2000 bytes to $3000
		p := #values;
		for i := 0 to 2000 do
		begin
			DMA::lpoke($00,$00,$3000+i,p^);
			p:=p+1;
		end;
		// copy 2000 bytes from $3000 to $0800 - full screen
		DMA::lcopy($00,$00,$3000,$00,$00,$0800,2000);
		
		// fill upper part of the screen with $00 (@)
		DMA::lfill($00,$00,$0800,$00,1000);
		
		// fill color ram - nibble flip, dont know why.... $ff,$08,$0000 -> $0ff80000 color ram
		DMA::lfill($ff,$08,$0000,$8,4000);
		loop();
end.

